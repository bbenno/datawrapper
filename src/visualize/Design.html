<HookBlocks key="design-blocks" />

{#if groups.layout.length }
<Group label="{__('layout / group-layout')}">
    <LayoutBlocks bind:blocks="groups.layout" />
</Group>
{/if} {#if groups.footer.length }
<Group label="{__('layout / group-footer')}">
    <LayoutBlocks bind:blocks="groups.footer" />
</Group>
{/if} {#if groups.sharing.length }
<Group label="{__('layout / group-sharing')}">
    <LayoutBlocks bind:blocks="groups.sharing" />
</Group>
{/if}

<script>
    /* globals dw */
    import { __ } from '@datawrapper/shared/l10n';
    import { Group } from '@datawrapper/controls';
    import get from '@datawrapper/shared/get';
    import arrayToObject from '@datawrapper/shared/arrayToObject';
    import HookBlocks from '@datawrapper/controls/editor/HookBlocks.html';
    import LayoutBlocks from '@datawrapper/controls/editor/LayoutBlocks.html';
    import GetTheDataControl from '@datawrapper/controls/editor/GetTheDataControl.html';
    import EmbedControl from '@datawrapper/controls/editor/EmbedControl.html';
    import ThemeSelectControl from '@datawrapper/controls/editor/ThemeSelectControl.html';
    import LogoControl from '@datawrapper/controls/editor/LogoControl.html';

    function getBlocks(allBlocks, group, props) {
        return allBlocks
            .filter(d => d.group === group)
            .filter(d => (d.visible !== undefined ? d.visible : true))
            .sort(byPriority);
    }
    function byPriority(a, b) {
        return (
            (a.priority !== undefined ? a.priority : 999) -
            (b.priority !== undefined ? b.priority : 999)
        );
    }

    export default {
        components: {
            Group,
            HookBlocks,
            LayoutBlocks
        },
        data() {
            return {
                allBlocks: [],
                hookBlocks: []
            };
        },
        computed: {
            groups({ $organizationId, $teamSettings, allBlocks }) {
                return {
                    footer: getBlocks(allBlocks, 'footer'),
                    layout: getBlocks(allBlocks, 'layout'),
                    sharing: getBlocks(allBlocks, 'sharing')
                };
            },
            coreBlocks({ $organizationId, $teamSettings, themeHasLogo, $theme }) {
                const flags = $teamSettings.flags;
                return [
                    {
                        ui: EmbedControl,
                        label: 'Enable embed',
                        visible: flags.embed || !$organizationId,
                        group: 'footer',
                        priority: 10
                    },
                    {
                        ui: GetTheDataControl,
                        label: 'Enable data download',
                        visible: flags.get_the_data || !$organizationId,
                        group: 'footer',
                        priority: 0
                    },
                    {
                        ui: LogoControl,
                        label: 'Logo',
                        visible: flags.logo || !$organizationId,
                        group: 'layout',
                        priority: 1
                    },
                    {
                        ui: ThemeSelectControl,
                        visible: flags.layout_selector || !$organizationId,
                        group: 'layout',
                        priority: 0
                    }
                ];
            },
            themeHasLogo({ $themeData }) {
                return (
                    get($themeData, 'options.footer.logo.url') ||
                    get($themeData, 'options.footer.logo.text')
                );
            }
        },
        helpers: { __ },
        oncreate() {
            const chart = this.store;
            let options = this.store.getMetadata('publish.options', {});
            options = arrayToObject(options);
            this.store.setMetadata('publish.options', options);
            const { results } = dw.backend.hooks.call(`design-blocks-grouped`, [chart]);
            this.set({ hookBlocks: results });
        },
        onstate({ previous, current, changed }) {
            if (previous) {
                const allBlocks = [...current.hookBlocks, ...(current.coreBlocks || [])];
                this.set({ allBlocks });
            }
        }
    };
</script>
